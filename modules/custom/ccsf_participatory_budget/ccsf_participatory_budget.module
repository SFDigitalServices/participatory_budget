<?php
// vi: filetype=php

function ccsf_participatory_budget_theme($existing, $type, $theme, $path) {
  return array(
    'ccsf_participatory_budget__district_contact' => array(
      'variables' => array(
        'district' => null
      ),
    ),
  );
}

/**
 * Implements hook_toolbar().
 *
 * Adds tabs (page actions) to admin_toolbar
 *
 * Borrowed from https://www.drupal.org/node/2759345#comment-12283927
 */
function ccsf_participatory_budget_toolbar() {
  $links = [];

  $localTasks = \Drupal::service('plugin.manager.menu.local_task')->getLocalTasks(\Drupal::routeMatch()->getRouteName(), 0);

  if (empty($localTasks['tabs'])) {
    return $links;
  }

  //$localTasks = \Drupal\Core\Menu\DefaultMenuLinkTreeManipulators::checkAccess($localTasks);

  foreach ($localTasks['tabs'] as $routeName => $value) {
    // Add to array by #weight so that we have the correct order
    $links[$value['#weight']] = $value['#link'];
  }

  // Sort into correct order
  ksort($links);

  // Add the menu local tasks into the toolbar.
  $items['local_tasks'] = [
    '#type' => 'toolbar_item',
    'tab' => [
      '#type' => 'html_tag',
      '#tag' => 'button',
      '#value' => t('Actions'),
      '#attributes' => [
        'title' => t('Local tasks'),
        'class' => ['toolbar-icon', 'toolbar-icon-system-admin-content'],
        ],
      ],
      'tray' => [
        '#heading' => t('Local tasks'),
        'toolbar_administration' => [
          '#attributes' => [
            'class' => ['toolbar-menu'],
          ],
        '#links' => $links,
        '#theme' => 'links__toolbar_ccsf_participatory_budget_toolbar',
        ],
      ],
      '#weight' => 1000,
    ];

  return $items;
}
